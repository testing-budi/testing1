data:text/x-python;base64,ZnJvbSBnaXRodWIgaW1wb3J0IEdpdGh1YgppbXBvcnQganNvbgoKCmRlZiBsb2dpbl90b2tlbihhY2Nlc3NfdG9rZW4pOgogICAgZ2l0aHViX3NlcnZpY2UgPSBHaXRodWIoYWNjZXNzX3Rva2VuKQogICAgcmV0dXJuIGdpdGh1Yl9zZXJ2aWNlCgoKZGVmIGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKToKICAgIGlmICJhY2Nlc3NUb2tlbiIgaW4gY3JlZGVudGlhbHM6CiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBsb2dpbl90b2tlbihhY2Nlc3NfdG9rZW49Y3JlZGVudGlhbHNbImFjY2Vzc1Rva2VuIl0pCiAgICBlbHNlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiSW52YWxpZCBDcmVkZW50aWFscyIpCiAgICByZXR1cm4gZ2l0aHViX3NlcnZpY2UKCgpkZWYgY29udmVydGRhdGVUb1N0cmluZyhkYXRlKToKICAgIGlmIHR5cGUoZGF0ZSkgPT0gc3RyOgogICAgICAgIHJldHVybiBkYXRlCiAgICBkYXRlX2Zvcm1hdCA9ICIlWS0lbS0lZFQlSDolTSIKICAgIGRhdGVfc3RyaW5nID0gZGF0ZS5zdHJmdGltZShkYXRlX2Zvcm1hdCkKICAgIHJldHVybiBkYXRlX3N0cmluZwoKCmRlZiBqc29uaWZ5X3JlcG8ocmVwbyk6CiAgICByZXR1cm4gewogICAgICAgICJpZCI6IHJlcG8uaWQsCiAgICAgICAgIm5hbWUiOiByZXBvLm5hbWUsCiAgICAgICAgImZ1bGxfbmFtZSI6IHJlcG8uZnVsbF9uYW1lLAogICAgICAgICJvd25lciI6IHJlcG8ub3duZXIubG9naW4sCiAgICAgICAgImRlc2NyaXB0aW9uIjogcmVwby5kZXNjcmlwdGlvbiwKICAgICAgICAicHJpdmF0ZSI6IHJlcG8ucHJpdmF0ZSwKICAgICAgICAic2l6ZSI6IHJlcG8uc2l6ZSwKICAgICAgICAidXJsIjogcmVwby51cmwsCiAgICAgICAgImh0bWxfdXJsIjogcmVwby5odG1sX3VybCwKICAgICAgICAiY3JlYXRlZF9hdCI6IGNvbnZlcnRkYXRlVG9TdHJpbmcocmVwby5jcmVhdGVkX2F0KSwKICAgICAgICAidXBkYXRlZF9hdCI6IGNvbnZlcnRkYXRlVG9TdHJpbmcocmVwby51cGRhdGVkX2F0KSwKICAgICAgICAicHVzaGVkX2F0IjogY29udmVydGRhdGVUb1N0cmluZyhyZXBvLnB1c2hlZF9hdCksCiAgICB9CgoKZGVmIGpzb25pZnlfaXNzc3VlKGlzc3VlKToKICAgIHJldHVybiB7CiAgICAgICAgImlkIjogaXNzdWUuaWQsCiAgICAgICAgInRpdGxlIjogaXNzdWUudGl0bGUsCiAgICAgICAgImJvZHkiOiBpc3N1ZS5ib2R5LAogICAgICAgICJsb2NrZWQiOiBpc3N1ZS5sb2NrZWQsCiAgICAgICAgInVybCI6IGlzc3VlLnVybCwKICAgICAgICAiaHRtbF91cmwiOiBpc3N1ZS5odG1sX3VybCwKICAgICAgICAiY3JlYXRlZF9hdCI6IGNvbnZlcnRkYXRlVG9TdHJpbmcoaXNzdWUuY3JlYXRlZF9hdCksCiAgICAgICAgInVwZGF0ZWRfYXQiOiBjb252ZXJ0ZGF0ZVRvU3RyaW5nKGlzc3VlLnVwZGF0ZWRfYXQpLAogICAgICAgICJudW1iZXIiOiBpc3N1ZS5udW1iZXIsCiAgICB9CgoKZGVmIGpzb25pZnlfcmVsZWFzZShyZWxlYXNlKToKICAgIHJldHVybiB7CiAgICAgICAgImlkIjogcmVsZWFzZS5pZCwKICAgICAgICAidGFnX25hbWUiOiByZWxlYXNlLnRhZ19uYW1lLAogICAgICAgICJuYW1lIjogcmVsZWFzZS50aXRsZSwKICAgICAgICAiYm9keSI6IHJlbGVhc2UuYm9keSwKICAgICAgICAidXJsIjogcmVsZWFzZS51cmwsCiAgICAgICAgImh0bWxfdXJsIjogcmVsZWFzZS5odG1sX3VybCwKICAgICAgICAiY3JlYXRlZF9hdCI6IGNvbnZlcnRkYXRlVG9TdHJpbmcocmVsZWFzZS5jcmVhdGVkX2F0KSwKICAgIH0KCgpkZWYganNvbmlmeV9maWxlKGZpbGUpOgogICAgcmV0dXJuIHsKICAgICAgICAibmFtZSI6IGZpbGUubmFtZSwKICAgICAgICAicGF0aCI6IGZpbGUucGF0aCwKICAgICAgICAic2hhIjogZmlsZS5zaGEsCiAgICAgICAgInVybCI6IGZpbGUudXJsLAogICAgICAgICJodG1sX3VybCI6IGZpbGUuaHRtbF91cmwsCiAgICAgICAgInR5cGUiOiBmaWxlLnR5cGUsCiAgICAgICAgImNvbnRlbnQiOiBmaWxlLmNvbnRlbnQsCiAgICAgICAgImVuY29kaW5nIjogZmlsZS5lbmNvZGluZywKICAgICAgICAic2l6ZSI6IGZpbGUuc2l6ZSwKICAgICAgICAiZGVjb2RlZF9jb250ZW50IjogZmlsZS5kZWNvZGVkX2NvbnRlbnQuZGVjb2RlKCJ1dGYtOCIpLAogICAgfQoKCgpkZWYgZ2l0aHViX2dldF91c2VyX3JlcG9zKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBHZXQgYSBsaXN0IG9mIHJlcG9zaXRvcmllcyBmb3IgYSBHaXRIdWIgdXNlci4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCiAgICAKICAgICAgICAtIDp1c2VybmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIEdpdEh1YiB1c2VybmFtZSBmb3Igd2hpY2ggdG8gcmV0cmlldmUgcmVwb3NpdG9yaWVzLgoKICAgIDpyZXR1cm46IEEgbGlzdCBvZiByZXBvc2l0b3JpZXMgZm9yIHRoZSBzcGVjaWZpZWQgR2l0SHViIHVzZXIuCiAgICA6cnR5cGU6IGxpc3QKICAgIDpyYWlzZXMgRXhjZXB0aW9uOiBJZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIHRoZSBHaXRIdWIgQVBJIG9yIG1pc3NpbmcgaW5wdXQgZGF0YS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIGNyZWRlbnRpYWxzPWpzb24ubG9hZHMoY3JlZHMpCiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBoYW5kbGVfYXV0aChjcmVkZW50aWFscykKICAgICAgICBpZiAoCiAgICAgICAgICAgICJ1c2VybmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInVzZXJuYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sidXNlcm5hbWUiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIHVzZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbInVzZXJuYW1lIl0pCiAgICAgICAgICAgIHJlcG9zID0gdXNlci5nZXRfcmVwb3MoKQogICAgICAgICAgICByZXR1cm4gW2pzb25pZnlfcmVwbyhyZXBvKSBmb3IgcmVwbyBpbiByZXBvc10KICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk1pc3NpbmcgaW5wdXQgZGF0YSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGUpCgoKZGVmIGdpdGh1Yl9nZXRfcmVwb19saWNlbnNlKGNyZWRzLHBhcmFtcyk6CiAgICAiIiIKICAgIEdldCB0aGUgbGljZW5zZSBpbmZvcm1hdGlvbiBmb3IgYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgoKICAgIDpyZXR1cm46IExpY2Vuc2UgaW5mb3JtYXRpb24gZm9yIHRoZSBzcGVjaWZpZWQgR2l0SHViIHJlcG9zaXRvcnkuCiAgICA6cnR5cGU6IGRpY3QKICAgIDpyYWlzZXMgRXhjZXB0aW9uOiBJZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIHRoZSBHaXRIdWIgQVBJIG9yIG1pc3NpbmcgaW5wdXQgZGF0YS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIGNyZWRlbnRpYWxzPWpzb24ubG9hZHMoY3JlZHMpCiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBoYW5kbGVfYXV0aChjcmVkZW50aWFscykKICAgICAgICBpZiAoCiAgICAgICAgICAgICJvd25lciIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgInJlcG9fbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICBjb250ZW50cyA9IHJlcG8uZ2V0X2NvbnRlbnRzKCJMSUNFTlNFIikKICAgICAgICAgICAgcmV0dXJuIGNvbnRlbnRzLl9yYXdEYXRhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfZ2V0X3JlcG9faXNzdWVzKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBHZXQgYSBsaXN0IG9mIGlzc3VlcyBmb3IgYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgoKICAgIDpyZXR1cm46IEEgbGlzdCBvZiBpc3N1ZXMgZm9yIHRoZSBzcGVjaWZpZWQgR2l0SHViIHJlcG9zaXRvcnkuCiAgICA6cnR5cGU6IGxpc3QKICAgIDpyYWlzZXMgRXhjZXB0aW9uOiBJZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIHRoZSBHaXRIdWIgQVBJIG9yIG1pc3NpbmcgaW5wdXQgZGF0YS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIGNyZWRlbnRpYWxzPWpzb24ubG9hZHMoY3JlZHMpCiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBoYW5kbGVfYXV0aChjcmVkZW50aWFscykKICAgICAgICBpZiAoCiAgICAgICAgICAgICJvd25lciIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgInJlcG9fbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICBpc3N1ZXMgPSByZXBvLmdldF9pc3N1ZXMoKQogICAgICAgICAgICByZXR1cm4gW2pzb25pZnlfaXNzc3VlKGlzc3VlPWlzc3VlKSBmb3IgaXNzdWUgaW4gaXNzdWVzXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2dldF9yZXBvKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgoKICAgIDpyZXR1cm46IEluZm9ybWF0aW9uIGFib3V0IHRoZSBzcGVjaWZpZWQgR2l0SHViIHJlcG9zaXRvcnkuCiAgICA6cnR5cGU6IGRpY3QKICAgIDpyYWlzZXMgRXhjZXB0aW9uOiBJZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIHRoZSBHaXRIdWIgQVBJIG9yIG1pc3NpbmcgaW5wdXQgZGF0YS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIGNyZWRlbnRpYWxzPWpzb24ubG9hZHMoY3JlZHMpCiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBoYW5kbGVfYXV0aChjcmVkZW50aWFscykKICAgICAgICBpZiAoCiAgICAgICAgICAgICJvd25lciIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgInJlcG9fbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICByZXR1cm4ganNvbmlmeV9yZXBvKHJlcG8pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfY3JlYXRlX3JlcG9fcmVsZWFzZShjcmVkcywgcGFyYW1zKToKICAgICIiIgogICAgQ3JlYXRlIGEgcmVsZWFzZSBmb3IgYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnRhZ19uYW1lOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbmFtZSBvZiB0aGUgdGFnIGZvciB0aGUgcmVsZWFzZS4KICAgICAgICAtIDphZGRpdGlvbmFsczogKGRpY3QsIG9wdGlvbmFsKSAtIEFkZGl0aW9uYWwgcGFyYW1ldGVycyBmb3IgY3JlYXRpbmcgdGhlIHJlbGVhc2UuCgogICAgOnJldHVybjogSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNyZWF0ZWQgcmVsZWFzZS4KICAgIDpydHlwZTogZGljdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm93bmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdICE9ICIiCiAgICAgICAgICAgIGFuZCAicmVwb19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJ0YWdfbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInRhZ19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sidGFnX25hbWUiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIG93bmVyID0gZ2l0aHViX3NlcnZpY2UuZ2V0X3VzZXIocGFyYW1zWyJvd25lciJdKQogICAgICAgICAgICByZXBvID0gb3duZXIuZ2V0X3JlcG8ocGFyYW1zWyJyZXBvX25hbWUiXSkKICAgICAgICAgICAgYXJncyA9IHt9CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICJhZGRpdGlvbmFscyIgaW4gcGFyYW1zCiAgICAgICAgICAgICAgICBhbmQgcGFyYW1zWyJhZGRpdGlvbmFscyJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgICAgICBhbmQgcGFyYW1zWyJhZGRpdGlvbmFscyJdICE9IHt9CiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBhcmdzID0gcGFyYW1zWyJhZGRpdGlvbmFscyJdCiAgICAgICAgICAgIHJlbGVhc2UgPSByZXBvLmNyZWF0ZV9naXRfcmVsZWFzZSh0YWc9cGFyYW1zWyJ0YWdfbmFtZSJdLCAqKmFyZ3MpCiAgICAgICAgICAgIHJldHVybiBqc29uaWZ5X3JlbGVhc2UocmVsZWFzZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk1pc3NpbmcgaW5wdXQgZGF0YSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGUpCgoKZGVmIGdpdGh1Yl9nZXRfcmVwb19yZWxlYXNlcyhjcmVkcywgcGFyYW1zKToKICAgICIiIgogICAgR2V0IGEgbGlzdCBvZiByZWxlYXNlcyBmb3IgYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgoKICAgIDpyZXR1cm46IEEgbGlzdCBvZiByZWxlYXNlcyBmb3IgdGhlIHNwZWNpZmllZCBHaXRIdWIgcmVwb3NpdG9yeS4KICAgIDpydHlwZTogbGlzdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm93bmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdICE9ICIiCiAgICAgICAgICAgIGFuZCAicmVwb19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gIT0gIiIKICAgICAgICApOgogICAgICAgICAgICBvd25lciA9IGdpdGh1Yl9zZXJ2aWNlLmdldF91c2VyKHBhcmFtc1sib3duZXIiXSkKICAgICAgICAgICAgcmVwbyA9IG93bmVyLmdldF9yZXBvKHBhcmFtc1sicmVwb19uYW1lIl0pCiAgICAgICAgICAgIHJlbGVhc2VzID0gcmVwby5nZXRfcmVsZWFzZXMoKQogICAgICAgICAgICByZXR1cm4gW2pzb25pZnlfcmVsZWFzZShyZWxlYXNlPXJlbGVhc2UpIGZvciByZWxlYXNlIGluIHJlbGVhc2VzXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2dldF9yZWxlYXNlKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYSBHaXRIdWIgcmVsZWFzZS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnRhZ19uYW1lOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbmFtZSBvZiB0aGUgdGFnIGZvciB0aGUgcmVsZWFzZS4KCiAgICA6cmV0dXJuOiBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc3BlY2lmaWVkIEdpdEh1YiByZWxlYXNlLgogICAgOnJ0eXBlOiBkaWN0CiAgICA6cmFpc2VzIEV4Y2VwdGlvbjogSWYgdGhlcmUgaXMgYW4gaXNzdWUgd2l0aCB0aGUgR2l0SHViIEFQSSBvciBtaXNzaW5nIGlucHV0IGRhdGEuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBjcmVkZW50aWFscz1qc29uLmxvYWRzKGNyZWRzKQogICAgICAgIGdpdGh1Yl9zZXJ2aWNlID0gaGFuZGxlX2F1dGgoY3JlZGVudGlhbHMpCiAgICAgICAgaWYgKAogICAgICAgICAgICAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICAgICBhbmQgInRhZ19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sidGFnX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJ0YWdfbmFtZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICByZWxlYXNlID0gcmVwby5nZXRfcmVsZWFzZShwYXJhbXNbInRhZ19uYW1lIl0pCiAgICAgICAgICAgIHJldHVybiBqc29uaWZ5X3JlbGVhc2UocmVsZWFzZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk1pc3NpbmcgaW5wdXQgZGF0YSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGUpCgoKZGVmIGdpdGh1Yl91cGRhdGVfcmVsZWFzZShjcmVkcywgcGFyYW1zKToKICAgICIiIgogICAgVXBkYXRlIGluZm9ybWF0aW9uIGFib3V0IGEgR2l0SHViIHJlbGVhc2UuCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpvd25lcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG93bmVyIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDpyZXBvX25hbWU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDp0YWdfbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIHRhZyBmb3IgdGhlIHJlbGVhc2UuCiAgICAgICAgLSA6YWRkaXRpb25hbHM6IChkaWN0LCBvcHRpb25hbCkgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgZm9yIHVwZGF0aW5nIHRoZSByZWxlYXNlLgoKICAgIDpyZXR1cm46IFVwZGF0ZWQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIEdpdEh1YiByZWxlYXNlLgogICAgOnJ0eXBlOiBkaWN0CiAgICA6cmFpc2VzIEV4Y2VwdGlvbjogSWYgdGhlcmUgaXMgYW4gaXNzdWUgd2l0aCB0aGUgR2l0SHViIEFQSSBvciBtaXNzaW5nIGlucHV0IGRhdGEuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBjcmVkZW50aWFscz1qc29uLmxvYWRzKGNyZWRzKQogICAgICAgIGdpdGh1Yl9zZXJ2aWNlID0gaGFuZGxlX2F1dGgoY3JlZGVudGlhbHMpCiAgICAgICAgaWYgKAogICAgICAgICAgICAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICAgICBhbmQgInRhZ19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sidGFnX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJ0YWdfbmFtZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICByZWxlYXNlID0gcmVwby5nZXRfcmVsZWFzZShwYXJhbXNbInRhZ19uYW1lIl0pCiAgICAgICAgICAgIGFyZ3MgPSB7fQogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAiYWRkaXRpb25hbHMiIGluIHBhcmFtcwogICAgICAgICAgICAgICAgYW5kIHBhcmFtc1siYWRkaXRpb25hbHMiXSBpcyBub3QgTm9uZQogICAgICAgICAgICAgICAgYW5kIHBhcmFtc1siYWRkaXRpb25hbHMiXSAhPSB7fQogICAgICAgICAgICApOgogICAgICAgICAgICAgICAgYXJncyA9IHBhcmFtc1siYWRkaXRpb25hbHMiXQogICAgICAgICAgICByZWxlYXNlID0gcmVsZWFzZS51cGRhdGVfcmVsZWFzZSgqKmFyZ3MpCiAgICAgICAgICAgIHJldHVybiBqc29uaWZ5X3JlbGVhc2UocmVsZWFzZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk1pc3NpbmcgaW5wdXQgZGF0YSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGUpCgoKZGVmIGdpaHR1Yl9kZWxldGVfcmVsZWFzZShjcmVkcywgcGFyYW1zKToKICAgICIiIgogICAgRGVsZXRlIGEgR2l0SHViIHJlbGVhc2UuCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpvd25lcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG93bmVyIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDpyZXBvX25hbWU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDp0YWdfbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIHRhZyBmb3IgdGhlIHJlbGVhc2UuCgogICAgOnJldHVybjogQSBtZXNzYWdlIGluZGljYXRpbmcgc3VjY2Vzc2Z1bCBkZWxldGlvbiBvZiB0aGUgR2l0SHViIHJlbGVhc2UuCiAgICA6cnR5cGU6IHN0cgogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm93bmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdICE9ICIiCiAgICAgICAgICAgIGFuZCAicmVwb19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJ0YWdfbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInRhZ19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sidGFnX25hbWUiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIG93bmVyID0gZ2l0aHViX3NlcnZpY2UuZ2V0X3VzZXIocGFyYW1zWyJvd25lciJdKQogICAgICAgICAgICByZXBvID0gb3duZXIuZ2V0X3JlcG8ocGFyYW1zWyJyZXBvX25hbWUiXSkKICAgICAgICAgICAgcmVsZWFzZSA9IHJlcG8uZ2V0X3JlbGVhc2UocGFyYW1zWyJ0YWdfbmFtZSJdKQogICAgICAgICAgICByZWxlYXNlLmRlbGV0ZV9yZWxlYXNlKCkKICAgICAgICAgICAgcmV0dXJuICJSZWxlYXNlIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2dldF9vcmdhbml6YXRpb25fcmVwb3MoY3JlZHMsIHBhcmFtcyk6CiAgICAiIiIKICAgIEdldCBhIGxpc3Qgb2YgcmVwb3NpdG9yaWVzIGZvciBhIEdpdEh1YiBvcmdhbml6YXRpb24uCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpvcmdhbml6YXRpb246IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgb3JnYW5pemF0aW9uLgoKICAgIDpyZXR1cm46IEEgbGlzdCBvZiByZXBvc2l0b3JpZXMgZm9yIHRoZSBzcGVjaWZpZWQgR2l0SHViIG9yZ2FuaXphdGlvbi4KICAgIDpydHlwZTogbGlzdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm9yZ2FuaXphdGlvbiIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm9yZ2FuaXphdGlvbiJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm9yZ2FuaXphdGlvbiJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3JnYW5pemF0aW9uID0gZ2l0aHViX3NlcnZpY2UuZ2V0X29yZ2FuaXphdGlvbihwYXJhbXNbIm9yZ2FuaXphdGlvbiJdKQogICAgICAgICAgICByZXBvcyA9IG9yZ2FuaXphdGlvbi5nZXRfcmVwb3MoKQogICAgICAgICAgICByZXR1cm4gW2pzb25pZnlfcmVwbyhyZXBvKSBmb3IgcmVwbyBpbiByZXBvc10KICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oIk1pc3NpbmcgaW5wdXQgZGF0YSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcmFpc2UgRXhjZXB0aW9uKGUpCgoKZGVmIGdpdGh1Yl9jcmVhdGVfaXNzdWUoY3JlZHMsIHBhcmFtcyk6CiAgICAiIiIKICAgIENyZWF0ZSBhIEdpdEh1YiBpc3N1ZSBmb3IgYSByZXBvc2l0b3J5LgoKICAgIDpwYXJhbSBjcmVkZW50aWFsczogRGljdGlvbmFyeSBjb250YWluaW5nIEdpdEh1YiBhdXRoZW50aWNhdGlvbiBjcmVkZW50aWFscy4KICAgIDp0eXBlIGNyZWRlbnRpYWxzOiBkaWN0CiAgICA6cGFyYW0gcGFyYW1zOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgcGFyYW1ldGVycy4KCiAgICAgICAgLSA6b3duZXI6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBvd25lciBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCiAgICAgICAgLSA6cmVwb19uYW1lOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbmFtZSBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCiAgICAgICAgLSA6dGl0bGU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSB0aXRsZSBvZiB0aGUgR2l0SHViIGlzc3VlLgogICAgICAgIC0gOmFkZGl0aW9uYWxzOiAoZGljdCwgb3B0aW9uYWwpIC0gQWRkaXRpb25hbCBwYXJhbWV0ZXJzIGZvciBjcmVhdGluZyB0aGUgaXNzdWUuCgogICAgOnJldHVybjogSW5mb3JtYXRpb24gYWJvdXQgdGhlIGNyZWF0ZWQgR2l0SHViIGlzc3VlLgogICAgOnJ0eXBlOiBkaWN0CiAgICA6cmFpc2VzIEV4Y2VwdGlvbjogSWYgdGhlcmUgaXMgYW4gaXNzdWUgd2l0aCB0aGUgR2l0SHViIEFQSSBvciBtaXNzaW5nIGlucHV0IGRhdGEuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBjcmVkZW50aWFscz1qc29uLmxvYWRzKGNyZWRzKQogICAgICAgIGdpdGh1Yl9zZXJ2aWNlID0gaGFuZGxlX2F1dGgoY3JlZGVudGlhbHMpCiAgICAgICAgaWYgKAogICAgICAgICAgICAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICAgICBhbmQgInRpdGxlIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sidGl0bGUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJ0aXRsZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICB0aXRsZSA9IHBhcmFtc1sidGl0bGUiXQogICAgICAgICAgICBhcmdzID0ge30KICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgImFkZGl0aW9uYWxzIiBpbiBwYXJhbXMKICAgICAgICAgICAgICAgIGFuZCBwYXJhbXNbImFkZGl0aW9uYWxzIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgICAgIGFuZCBwYXJhbXNbImFkZGl0aW9uYWxzIl0gIT0ge30KICAgICAgICAgICAgKToKICAgICAgICAgICAgICAgIGFyZ3MgPSBwYXJhbXNbImFkZGl0aW9uYWxzIl0KICAgICAgICAgICAgaXNzdWUgPSByZXBvLmNyZWF0ZV9pc3N1ZSh0aXRsZT10aXRsZSwgKiphcmdzKQogICAgICAgICAgICByZXR1cm4ganNvbmlmeV9pc3NzdWUoaXNzdWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfZ2V0X2lzc3VlKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBHZXQgaW5mb3JtYXRpb24gYWJvdXQgYSBHaXRIdWIgaXNzdWUuCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpvd25lcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG93bmVyIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDpyZXBvX25hbWU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDppc3N1ZV9udW1iZXI6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBudW1iZXIgb2YgdGhlIEdpdEh1YiBpc3N1ZS4KCiAgICA6cmV0dXJuOiBJbmZvcm1hdGlvbiBhYm91dCB0aGUgc3BlY2lmaWVkIEdpdEh1YiBpc3N1ZS4KICAgIDpydHlwZTogZGljdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm93bmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdICE9ICIiCiAgICAgICAgICAgIGFuZCAicmVwb19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJpc3N1ZV9udW1iZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJpc3N1ZV9udW1iZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJpc3N1ZV9udW1iZXIiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIG93bmVyID0gZ2l0aHViX3NlcnZpY2UuZ2V0X3VzZXIocGFyYW1zWyJvd25lciJdKQogICAgICAgICAgICByZXBvID0gb3duZXIuZ2V0X3JlcG8ocGFyYW1zWyJyZXBvX25hbWUiXSkKICAgICAgICAgICAgaXNzdWUgPSByZXBvLmdldF9pc3N1ZShwYXJhbXNbImlzc3VlX251bWJlciJdKQogICAgICAgICAgICByZXR1cm4ganNvbmlmeV9pc3NzdWUoaXNzdWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfY3JlYXRlX2lzc3VlX2NvbW1lbnQoY3JlZHMsIHBhcmFtcyk6CiAgICAiIiIKICAgIENyZWF0ZSBhIGNvbW1lbnQgZm9yIGEgR2l0SHViIGlzc3VlLgoKICAgIDpwYXJhbSBjcmVkZW50aWFsczogRGljdGlvbmFyeSBjb250YWluaW5nIEdpdEh1YiBhdXRoZW50aWNhdGlvbiBjcmVkZW50aWFscy4KICAgIDp0eXBlIGNyZWRlbnRpYWxzOiBkaWN0CiAgICA6cGFyYW0gcGFyYW1zOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgcGFyYW1ldGVycy4KCiAgICAgICAgLSA6b3duZXI6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBvd25lciBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCiAgICAgICAgLSA6cmVwb19uYW1lOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbmFtZSBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCiAgICAgICAgLSA6aXNzdWVfbnVtYmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbnVtYmVyIG9mIHRoZSBHaXRIdWIgaXNzdWUuCiAgICAgICAgLSA6Ym9keTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIGJvZHkgb2YgdGhlIGNvbW1lbnQuCgogICAgOnJldHVybjogSW5mb3JtYXRpb24gYWJvdXQgdGhlIEdpdEh1YiBpc3N1ZSBhZnRlciBjcmVhdGluZyB0aGUgY29tbWVudC4KICAgIDpydHlwZTogZGljdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgIm93bmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdICE9ICIiCiAgICAgICAgICAgIGFuZCAicmVwb19uYW1lIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicmVwb19uYW1lIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJpc3N1ZV9udW1iZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJpc3N1ZV9udW1iZXIiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJpc3N1ZV9udW1iZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgImJvZHkiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJib2R5Il0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1siYm9keSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICBpc3N1ZSA9IHJlcG8uZ2V0X2lzc3VlKHBhcmFtc1siaXNzdWVfbnVtYmVyIl0pCiAgICAgICAgICAgIGNvbW1lbnQgPSBpc3N1ZS5jcmVhdGVfY29tbWVudChwYXJhbXNbImJvZHkiXSkKICAgICAgICAgICAgcmV0dXJuIGpzb25pZnlfaXNzc3VlKGlzc3VlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2VkaXRfaXNzdWUoY3JlZHMsIHBhcmFtcyk6CiAgICAiIiIKICAgIEVkaXQgZGV0YWlscyBvZiBhIEdpdEh1YiBpc3N1ZS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOmlzc3VlX251bWJlcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG51bWJlciBvZiB0aGUgR2l0SHViIGlzc3VlLgogICAgICAgIC0gOmFkZGl0aW9uYWxzOiAoZGljdCwgb3B0aW9uYWwpIC0gQWRkaXRpb25hbCBwYXJhbWV0ZXJzIGZvciBlZGl0aW5nIHRoZSBpc3N1ZS4KCiAgICA6cmV0dXJuOiBJbmZvcm1hdGlvbiBhYm91dCB0aGUgR2l0SHViIGlzc3VlIGFmdGVyIGVkaXRpbmcuCiAgICA6cnR5cGU6IGRpY3QKICAgIDpyYWlzZXMgRXhjZXB0aW9uOiBJZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIHRoZSBHaXRIdWIgQVBJIG9yIG1pc3NpbmcgaW5wdXQgZGF0YS4KICAgICIiIgogICAgdHJ5OgogICAgICAgIGNyZWRlbnRpYWxzPWpzb24ubG9hZHMoY3JlZHMpCiAgICAgICAgZ2l0aHViX3NlcnZpY2UgPSBoYW5kbGVfYXV0aChjcmVkZW50aWFscykKICAgICAgICBpZiAoCiAgICAgICAgICAgICJvd25lciIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgInJlcG9fbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdICE9ICIiCiAgICAgICAgICAgIGFuZCAiaXNzdWVfbnVtYmVyIiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1siaXNzdWVfbnVtYmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1siaXNzdWVfbnVtYmVyIl0gIT0gIiIKICAgICAgICApOgogICAgICAgICAgICBvd25lciA9IGdpdGh1Yl9zZXJ2aWNlLmdldF91c2VyKHBhcmFtc1sib3duZXIiXSkKICAgICAgICAgICAgcmVwbyA9IG93bmVyLmdldF9yZXBvKHBhcmFtc1sicmVwb19uYW1lIl0pCiAgICAgICAgICAgIGlzc3VlID0gcmVwby5nZXRfaXNzdWUocGFyYW1zWyJpc3N1ZV9udW1iZXIiXSkKICAgICAgICAgICAgYXJncyA9IHt9CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICJhZGRpdGlvbmFscyIgaW4gcGFyYW1zCiAgICAgICAgICAgICAgICBhbmQgcGFyYW1zWyJhZGRpdGlvbmFscyJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgICAgICBhbmQgcGFyYW1zWyJhZGRpdGlvbmFscyJdICE9IHt9CiAgICAgICAgICAgICk6CiAgICAgICAgICAgICAgICBhcmdzID0gcGFyYW1zWyJhZGRpdGlvbmFscyJdCiAgICAgICAgICAgIGlzc3VlLmVkaXQoKiphcmdzKQogICAgICAgICAgICByZXR1cm4ganNvbmlmeV9pc3NzdWUoaXNzdWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfbGlzdF9maWxlKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBMaXN0IHRoZSBjb250ZW50IG9mIGEgZmlsZSBpbiBhIEdpdEh1YiByZXBvc2l0b3J5LgoKICAgIDpwYXJhbSBjcmVkZW50aWFsczogRGljdGlvbmFyeSBjb250YWluaW5nIEdpdEh1YiBhdXRoZW50aWNhdGlvbiBjcmVkZW50aWFscy4KICAgIDp0eXBlIGNyZWRlbnRpYWxzOiBkaWN0CiAgICA6cGFyYW0gcGFyYW1zOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgcGFyYW1ldGVycy4KCiAgICAgICAgLSA6cGF0aDogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIHBhdGggdG8gdGhlIGZpbGUuCiAgICAgICAgLSA6b3duZXI6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBvd25lciBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCiAgICAgICAgLSA6cmVwb19uYW1lOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgbmFtZSBvZiB0aGUgR2l0SHViIHJlcG9zaXRvcnkuCgogICAgOnJldHVybjogSW5mb3JtYXRpb24gYWJvdXQgdGhlIHNwZWNpZmllZCBmaWxlIGluIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgIDpydHlwZTogZGljdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgInBhdGgiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJwYXRoIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicGF0aCJdICE9ICIiCiAgICAgICAgICAgIGFuZCAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIG93bmVyID0gZ2l0aHViX3NlcnZpY2UuZ2V0X3VzZXIocGFyYW1zWyJvd25lciJdKQogICAgICAgICAgICByZXBvID0gb3duZXIuZ2V0X3JlcG8ocGFyYW1zWyJyZXBvX25hbWUiXSkKICAgICAgICAgICAgY29udGVudCA9IHJlcG8uZ2V0X2NvbnRlbnRzKHBhcmFtc1sicGF0aCJdKQogICAgICAgICAgICByZXR1cm4ganNvbmlmeV9maWxlKGNvbnRlbnQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQoKCmRlZiBnaXRodWJfY3JlYXRlX2ZpbGUoY3JlZHMsIHBhcmFtcyk6CiAgICAiIiIKICAgIENyZWF0ZSBhIG5ldyBmaWxlIGluIGEgR2l0SHViIHJlcG9zaXRvcnkuCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpwYXRoOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgcGF0aCB0byB0aGUgZmlsZS4KICAgICAgICAtIDpvd25lcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG93bmVyIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDpyZXBvX25hbWU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDptZXNzYWdlOiAoc3RyLCByZXF1aXJlZCkgLSBBIGNvbW1pdCBtZXNzYWdlIGZvciBjcmVhdGluZyB0aGUgZmlsZS4KICAgICAgICAtIDpjb250ZW50OiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgY29udGVudCBvZiB0aGUgZmlsZS4KCiAgICA6cmV0dXJuOiBJbmZvcm1hdGlvbiBhYm91dCB0aGUgY3JlYXRlZCBmaWxlIGluIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgIDpydHlwZTogZGljdAogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgInBhdGgiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJwYXRoIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicGF0aCJdICE9ICIiCiAgICAgICAgICAgIGFuZCAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICAgICBhbmQgIm1lc3NhZ2UiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJtZXNzYWdlIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sibWVzc2FnZSJdICE9ICIiCiAgICAgICAgICAgIGFuZCAiY29udGVudCIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbImNvbnRlbnQiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJjb250ZW50Il0gIT0gIiIKICAgICAgICApOgogICAgICAgICAgICBvd25lciA9IGdpdGh1Yl9zZXJ2aWNlLmdldF91c2VyKHBhcmFtc1sib3duZXIiXSkKICAgICAgICAgICAgcmVwbyA9IG93bmVyLmdldF9yZXBvKHBhcmFtc1sicmVwb19uYW1lIl0pCiAgICAgICAgICAgIGNvbnRlbnQgPSByZXBvLmNyZWF0ZV9maWxlKAogICAgICAgICAgICAgICAgcGFyYW1zWyJwYXRoIl0sIHBhcmFtc1sibWVzc2FnZSJdLCBwYXJhbXNbImNvbnRlbnQiXQogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybiBqc29uaWZ5X2ZpbGUoY29udGVudFsiY29udGVudCJdKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2RlbGV0ZV9maWxlKGNyZWRzLCBwYXJhbXMpOgogICAgIiIiCiAgICBEZWxldGUgYSBmaWxlIGZyb20gYSBHaXRIdWIgcmVwb3NpdG9yeS4KCiAgICA6cGFyYW0gY3JlZGVudGlhbHM6IERpY3Rpb25hcnkgY29udGFpbmluZyBHaXRIdWIgYXV0aGVudGljYXRpb24gY3JlZGVudGlhbHMuCiAgICA6dHlwZSBjcmVkZW50aWFsczogZGljdAogICAgOnBhcmFtIHBhcmFtczogRGljdGlvbmFyeSBjb250YWluaW5nIHBhcmFtZXRlcnMuCgogICAgICAgIC0gOnBhdGg6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBwYXRoIHRvIHRoZSBmaWxlLgogICAgICAgIC0gOm93bmVyOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgb3duZXIgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOnJlcG9fbmFtZTogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG5hbWUgb2YgdGhlIEdpdEh1YiByZXBvc2l0b3J5LgogICAgICAgIC0gOm1lc3NhZ2U6IChzdHIsIHJlcXVpcmVkKSAtIEEgY29tbWl0IG1lc3NhZ2UgZm9yIGRlbGV0aW5nIHRoZSBmaWxlLgoKICAgIDpyZXR1cm46IEEgbWVzc2FnZSBpbmRpY2F0aW5nIHN1Y2Nlc3NmdWwgZGVsZXRpb24gb2YgdGhlIGZpbGUuCiAgICA6cnR5cGU6IHN0cgogICAgOnJhaXNlcyBFeGNlcHRpb246IElmIHRoZXJlIGlzIGFuIGlzc3VlIHdpdGggdGhlIEdpdEh1YiBBUEkgb3IgbWlzc2luZyBpbnB1dCBkYXRhLgogICAgIiIiCiAgICB0cnk6CiAgICAgICAgY3JlZGVudGlhbHM9anNvbi5sb2FkcyhjcmVkcykKICAgICAgICBnaXRodWJfc2VydmljZSA9IGhhbmRsZV9hdXRoKGNyZWRlbnRpYWxzKQogICAgICAgIGlmICgKICAgICAgICAgICAgInBhdGgiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJwYXRoIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sicGF0aCJdICE9ICIiCiAgICAgICAgICAgIGFuZCAib3duZXIiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJvd25lciJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJyZXBvX25hbWUiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJyZXBvX25hbWUiXSAhPSAiIgogICAgICAgICAgICBhbmQgIm1lc3NhZ2UiIGluIHBhcmFtcwogICAgICAgICAgICBhbmQgcGFyYW1zWyJtZXNzYWdlIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sibWVzc2FnZSJdICE9ICIiCiAgICAgICAgKToKICAgICAgICAgICAgb3duZXIgPSBnaXRodWJfc2VydmljZS5nZXRfdXNlcihwYXJhbXNbIm93bmVyIl0pCiAgICAgICAgICAgIHJlcG8gPSBvd25lci5nZXRfcmVwbyhwYXJhbXNbInJlcG9fbmFtZSJdKQogICAgICAgICAgICBjb250ZW50ID0gcmVwby5nZXRfY29udGVudHMocGFyYW1zWyJwYXRoIl0pCiAgICAgICAgICAgIHJlcG8uZGVsZXRlX2ZpbGUocGFyYW1zWyJwYXRoIl0sIHBhcmFtc1sibWVzc2FnZSJdLCBjb250ZW50LnNoYSkKICAgICAgICAgICAgcmV0dXJuICJGaWxlIGRlbGV0ZWQgc3VjY2Vzc2Z1bGx5IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiTWlzc2luZyBpbnB1dCBkYXRhIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oZSkKCgpkZWYgZ2l0aHViX2VkaXRfZmlsZShjcmVkcywgcGFyYW1zKToKICAgICIiIgogICAgRWRpdCBhbiBleGlzdGluZyBmaWxlIGluIGEgR2l0SHViIHJlcG9zaXRvcnkuCgogICAgOnBhcmFtIGNyZWRlbnRpYWxzOiBEaWN0aW9uYXJ5IGNvbnRhaW5pbmcgR2l0SHViIGF1dGhlbnRpY2F0aW9uIGNyZWRlbnRpYWxzLgogICAgOnR5cGUgY3JlZGVudGlhbHM6IGRpY3QKICAgIDpwYXJhbSBwYXJhbXM6IERpY3Rpb25hcnkgY29udGFpbmluZyBwYXJhbWV0ZXJzLgoKICAgICAgICAtIDpwYXRoOiAoc3RyLCByZXF1aXJlZCkgLSBUaGUgcGF0aCB0byB0aGUgZmlsZS4KICAgICAgICAtIDpvd25lcjogKHN0ciwgcmVxdWlyZWQpIC0gVGhlIG93bmVyIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDpyZXBvX25hbWU6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuYW1lIG9mIHRoZSBHaXRIdWIgcmVwb3NpdG9yeS4KICAgICAgICAtIDptZXNzYWdlOiAoc3RyLCByZXF1aXJlZCkgLSBBIGNvbW1pdCBtZXNzYWdlIGZvciBlZGl0aW5nIHRoZSBmaWxlLgogICAgICAgIC0gOmNvbnRlbnQ6IChzdHIsIHJlcXVpcmVkKSAtIFRoZSBuZXcgY29udGVudCBvZiB0aGUgZmlsZS4KCiAgICA6cmV0dXJuOiBBIG1lc3NhZ2UgaW5kaWNhdGluZyBzdWNjZXNzZnVsIHVwZGF0ZSBvZiB0aGUgZmlsZS4KICAgIDpydHlwZTogc3RyCiAgICA6cmFpc2VzIEV4Y2VwdGlvbjogSWYgdGhlcmUgaXMgYW4gaXNzdWUgd2l0aCB0aGUgR2l0SHViIEFQSSBvciBtaXNzaW5nIGlucHV0IGRhdGEuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBjcmVkZW50aWFscz1qc29uLmxvYWRzKGNyZWRzKQogICAgICAgIGdpdGh1Yl9zZXJ2aWNlID0gaGFuZGxlX2F1dGgoY3JlZGVudGlhbHMpCiAgICAgICAgaWYgKAogICAgICAgICAgICAicGF0aCIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInBhdGgiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJwYXRoIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJvd25lciIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm93bmVyIl0gaXMgbm90IE5vbmUKICAgICAgICAgICAgYW5kIHBhcmFtc1sib3duZXIiXSAhPSAiIgogICAgICAgICAgICBhbmQgInJlcG9fbmFtZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbInJlcG9fbmFtZSJdICE9ICIiCiAgICAgICAgICAgIGFuZCAibWVzc2FnZSIgaW4gcGFyYW1zCiAgICAgICAgICAgIGFuZCBwYXJhbXNbIm1lc3NhZ2UiXSBpcyBub3QgTm9uZQogICAgICAgICAgICBhbmQgcGFyYW1zWyJtZXNzYWdlIl0gIT0gIiIKICAgICAgICAgICAgYW5kICJjb250ZW50IiBpbiBwYXJhbXMKICAgICAgICAgICAgYW5kIHBhcmFtc1siY29udGVudCJdIGlzIG5vdCBOb25lCiAgICAgICAgICAgIGFuZCBwYXJhbXNbImNvbnRlbnQiXSAhPSAiIgogICAgICAgICk6CiAgICAgICAgICAgIG93bmVyID0gZ2l0aHViX3NlcnZpY2UuZ2V0X3VzZXIocGFyYW1zWyJvd25lciJdKQogICAgICAgICAgICByZXBvID0gb3duZXIuZ2V0X3JlcG8ocGFyYW1zWyJyZXBvX25hbWUiXSkKICAgICAgICAgICAgY29udGVudCA9IHJlcG8uZ2V0X2NvbnRlbnRzKHBhcmFtc1sicGF0aCJdKQogICAgICAgICAgICByZXBvLnVwZGF0ZV9maWxlKAogICAgICAgICAgICAgICAgcGFyYW1zWyJwYXRoIl0sIHBhcmFtc1sibWVzc2FnZSJdLCBwYXJhbXNbImNvbnRlbnQiXSwgY29udGVudC5zaGEKICAgICAgICAgICAgKQogICAgICAgICAgICByZXR1cm4gIkZpbGUgdXBkYXRlZCBzdWNjZXNzZnVsbHkiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJNaXNzaW5nIGlucHV0IGRhdGEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHJhaXNlIEV4Y2VwdGlvbihlKQo=